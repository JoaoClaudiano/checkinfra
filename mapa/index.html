<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">

<title>Mapa Sanit√°rio ‚Äì CheckInfra</title>

<!-- Leaflet -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; background:#f4f6f8; }

/* Header */
header {
  background:#1f4fd8;
  color:#fff;
  padding:14px 12px;
  text-align:center;
  font-weight:bold;
  font-size:16px;
  position:sticky;
  top:0;
  z-index:999;
}

/* Navega√ß√£o */
.nav-global {
  position: fixed;
  top:14px;
  left:10px;
  display:flex;
  gap:8px;
  z-index:9999;
}
.nav-global button, .nav-global a {
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:50%;
  width:36px;
  height:36px;
  font-size:18px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  text-decoration:none;
}
.nav-global button:hover, .nav-global a:hover { background:#163aa9; }

/* Painel */
.painel {
  padding:6px 10px;
  background:#f4f6f8;
  display:flex;
  gap:10px;
  justify-content:center;
  font-size:13px;
  flex-wrap:wrap;
  position:sticky;
  top:52px;
  z-index:998;
  border-bottom:1px solid #ddd;
}
.painel label { display:flex; align-items:center; gap:4px; cursor:pointer; }

/* Cores */
.bola { width:12px; height:12px; border-radius:50%; display:inline-block; }
.verde { background:#4CAF50; }
.laranja { background:#FFD700; }
.amarela { background:#FF9800; }
.vermelho { background:#F44336; }

/* Pulso */
.pulse-critico { animation: pulse-red 2.4s ease-out infinite; }
.pulse-alerta  { animation: pulse-yellow 2.4s ease-out infinite; }
.pulse-atencao { animation: pulse-orange 2.4s ease-out infinite; }
.pulse-adequado{ animation: pulse-green 2.4s ease-out infinite; }

@keyframes pulse-red { 0% { r:8; opacity:.9; } 70% { r:18; opacity:0; } }
@keyframes pulse-yellow { 0% { r:8; opacity:.8; } 70% { r:16; opacity:0; } }
@keyframes pulse-orange { 0% { r:8; opacity:.8; } 70% { r:16; opacity:0; } }
@keyframes pulse-green { 0% { r:8; opacity:.7; } 70% { r:14; opacity:0; } }

/* Bairros */
.bairro-vermelho { fill:#de2d26; fill-opacity:.55; }
.bairro-laranja  { fill:#fd8d3c; fill-opacity:.55; }
.bairro-amarelo  { fill:#fecc5c; fill-opacity:.55; }
.bairro-verde    { fill:#74c476; fill-opacity:.45; }
.bairro-cinza    { fill:#cccccc; fill-opacity:.35; }

/* Mapa */
#map { height: calc(100vh - 110px); }

/* Legenda */
.legenda {
  background:#fff;
  padding:8px;
  font-size:12px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}
</style>
</head>

<body>

<header>
  üó∫Ô∏è Mapa Sanit√°rio das Escolas ‚Äî Vis√£o do Gestor
</header>

<div class="nav-global">
  <button onclick="history.back()">‚¨ÖÔ∏è</button>
  <a href="../index.html">üè†</a>
</div>

<div class="painel">
  <label><input type="checkbox" id="filtroAdequado" checked><span class="bola verde"></span> Adequado</label>
  <label><input type="checkbox" id="filtroAlerta" checked><span class="bola laranja"></span> Alerta</label>
  <label><input type="checkbox" id="filtroAtencao" checked><span class="bola amarela"></span> Aten√ß√£o</label>
  <label><input type="checkbox" id="filtroCritico" checked><span class="bola vermelho"></span> Cr√≠tico</label>
  <label><input type="checkbox" id="togglePulso" checked> Mapa vivo</label>
  <label><input type="checkbox" id="toggleBairros"> Bairros cr√≠ticos</label>
</div>

<div id="map"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* Firebase */
const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};
initializeApp(firebaseConfig);
const db = getFirestore();

/* Mapa */
const map = L.map("map").setView([-3.7319, -38.5267], 12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution:"¬© OpenStreetMap"
}).addTo(map);

/* Layers */
const camadaPontos = L.layerGroup().addTo(map);
let camadaBairros = null;

let pulsoAtivo = true;
let avaliacoes = [];

/* Utilidades */
function cor(status){
  status = status.toLowerCase();
  if(status.includes("cr√≠tica")) return "#F44336";
  if(status.includes("aten√ß√£o")) return "#FF9800";
  if(status.includes("alerta")) return "#FFD700";
  return "#4CAF50";
}
function pulso(status){
  if(!pulsoAtivo) return "";
  status = status.toLowerCase();
  if(status.includes("cr√≠tica")) return "pulse-critico";
  if(status.includes("aten√ß√£o")) return "pulse-atencao";
  if(status.includes("alerta")) return "pulse-alerta";
  return "pulse-adequado";
}

/* Carregar avalia√ß√µes */
async function carregarAvaliacoes(){
  const snap = await getDocs(collection(db,"avaliacoes"));
  avaliacoes = [];
  snap.forEach(doc=>{
    const d = doc.data();
    if(d.lat && d.lng) avaliacoes.push(d);
  });
}

/* Atualizar pontos */
function atualizarMapa(){
  camadaPontos.clearLayers();

  avaliacoes.forEach(d=>{
    if(d.status.includes("cr√≠tica") && !filtroCritico.checked) return;
    if(d.status.includes("aten√ß√£o") && !filtroAtencao.checked) return;
    if(d.status.includes("alerta") && !filtroAlerta.checked) return;
    if(d.status.includes("adequado") && !filtroAdequado.checked) return;

    L.circleMarker([d.lat,d.lng],{
      radius:8,
      color:cor(d.status),
      fillColor:cor(d.status),
      fillOpacity:.8,
      className:pulso(d.status)
    })
    .bindPopup(`<strong>${d.escola}</strong><br>Status: ${d.status}`)
    .addTo(camadaPontos);
  });
}

/* Indicador por bairro */
function indicador(layer){
  const dentro = avaliacoes.filter(a =>
    layer.getBounds().contains([a.lat,a.lng])
  );
  if(!dentro.length) return {cls:"bairro-cinza", pct:0};

  const crit = dentro.filter(a=>a.status.includes("cr√≠tica")).length;
  const pct = (crit/dentro.length)*100;

  if(pct>=50) return {cls:"bairro-vermelho", pct};
  if(pct>=25) return {cls:"bairro-laranja", pct};
  if(pct>0)  return {cls:"bairro-amarelo", pct};
  return {cls:"bairro-verde", pct};
}

/* Bairros */
async function carregarBairros(){
  const r = await fetch("./POLIGONAIS.geojson");
  const g = await r.json();

  camadaBairros = L.geoJSON(g,{
    style: f=>({ color:"#555", weight:1, fillOpacity:.5 }),
    onEachFeature:(f,l)=>{
      const i = indicador(l);
      l.setStyle({ className:i.cls });
      l.bindPopup(`<strong>${f.properties.nome || "Bairro"}</strong><br>${i.pct.toFixed(1)}% cr√≠ticas`);
    }
  });
}

/* Eventos */
togglePulso.onchange = e=>{ pulsoAtivo=e.target.checked; atualizarMapa(); };
[filtroAdequado,filtroAlerta,filtroAtencao,filtroCritico].forEach(c=>c.onchange=atualizarMapa);

toggleBairros.onchange = async e=>{
  if(e.target.checked){
    if(!camadaBairros) await carregarBairros();
    camadaBairros.addTo(map);
  } else {
    if(camadaBairros) map.removeLayer(camadaBairros);
  }
};

/* Init */
await carregarAvaliacoes();
atualizarMapa();
</script>

<footer style="background:#1f4fd8;color:#fff;text-align:center;padding:14px;font-size:12px;">
  ¬© 2025 CheckInfra ‚Äî Visualiza√ß√£o territorial explorat√≥ria. N√£o substitui vistoria t√©cnica.
</footer>

</body>
</html>