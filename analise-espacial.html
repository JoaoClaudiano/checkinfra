<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">

<title>An√°lise Espacial ‚Äì CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>

<style>
body { margin:0; font-family: Arial, sans-serif; }

header {
  background:#1f4fd8;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}

#map { height: calc(100vh - 260px); }

.painel {
  padding:10px;
  background:#f4f6f8;
  display:flex;
  gap:12px;
  justify-content:center;
  font-size:14px;
  flex-wrap:wrap;
}

.painel select, .painel label {
  display:flex;
  align-items:center;
  gap:6px;
}

.abas {
  display:flex;
  justify-content:center;
  background:#e9ecef;
  border-bottom:1px solid #ccc;
}

.abas button {
  padding:10px 16px;
  border:none;
  background:none;
  cursor:pointer;
  font-weight:bold;
}

.abas button.ativa {
  background:#fff;
  border-bottom:3px solid #1f4fd8;
}

.secao { display:none; }
.secao.ativa { display:block; }

.legenda {
  background:#fff;
  padding:10px;
  font-size:13px;
  border-radius:6px;
  box-shadow:0 1px 5px rgba(0,0,0,.3);
}

#ranking {
  padding:12px;
  font-size:14px;
}

#metodologia {
  padding:16px;
  font-size:14px;
  line-height:1.6;
}
</style>
</head>

<body>

<header>
  üß≠ An√°lise Espacial ‚Äì Leitura Territorial Explorat√≥ria
  <div style="font-size:12px;font-weight:normal;opacity:.9;">
    Indicadores espaciais relativos √†s condi√ß√µes sanit√°rias das escolas
  </div>
</header>

<div class="abas">
  <button class="ativa" onclick="abrirAba('mapa')">üó∫Ô∏è Mapa</button>
  <button onclick="abrirAba('ranking')">üìä Ranking</button>
  <button onclick="abrirAba('metodologia')">üìò Metodologia</button>
</div>

<!-- ===== MAPA ===== -->
<div id="mapa" class="secao ativa">

  <div class="painel">
    <label>
      Indicador:
      <select id="seletorIndicador">
        <option value="1">Indicador 1 ‚Äî Densidade Cr√≠tica</option>
        <option value="2">Indicador 2 ‚Äî Concentra√ß√£o Relativa</option>
      </select>
    </label>

    <label>
      <input type="checkbox" id="toggleZonas" checked>
      üü• Zonas priorit√°rias
    </label>
  </div>

  <div id="map"></div>
</div>

<!-- ===== RANKING ===== -->
<div id="ranking" class="secao">
  <h3>üìä Ranking Territorial ‚Äî Zonas Priorit√°rias</h3>
  <ol id="listaRanking"></ol>
</div>

<!-- ===== METODOLOGIA ===== -->
<div id="metodologia" class="secao">
  <h3>üìò Metodologia e Indicadores</h3>

  <p>
    Esta an√°lise utiliza <strong>unidades territoriais regulares</strong>
    (c√©lulas espaciais de aproximadamente 1 km¬≤) para identificar padr√µes
    de concentra√ß√£o relativa das condi√ß√µes sanit√°rias das escolas.
  </p>

  <h4>Indicadores</h4>
  <ul>
    <li><strong>Indicador 1 ‚Äì Densidade Cr√≠tica:</strong> enfatiza a presen√ßa absoluta de escolas em situa√ß√£o cr√≠tica.</li>
    <li><strong>Indicador 2 ‚Äì Concentra√ß√£o Relativa:</strong> pondera criticidade e alerta de forma equilibrada.</li>
  </ul>

  <h4>√çndice Territorial (0‚Äì100)</h4>
  <p>
    O √≠ndice territorial representa a intensidade relativa da condi√ß√£o sanit√°ria
    em cada c√©lula, normalizada em uma escala de 0 a 100, permitindo compara√ß√£o
    entre √°reas.
  </p>

  <p><em>
    As an√°lises s√£o explorat√≥rias e n√£o substituem vistorias t√©cnicas presenciais.
  </em></p>
</div>

<script>
/* =====================
   ABAS
===================== */
function abrirAba(id) {
  document.querySelectorAll(".secao").forEach(s => s.classList.remove("ativa"));
  document.querySelectorAll(".abas button").forEach(b => b.classList.remove("ativa"));
  document.getElementById(id).classList.add("ativa");
  event.target.classList.add("ativa");
}

/* =====================
   MAPA E DADOS
===================== */
const API_URL = "https://script.google.com/macros/s/AKfycbyt4wD8LQ67NOD-Zz7EEvfc7RuYEhKDYE50gkK7rp-47idg6STKUGqk5pYVDclamentdQ/exec";

const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "¬© OpenStreetMap"
}).addTo(map);

let modoIndicador = 1;
let dadosOriginais = [];

const camadaHeatmap = L.heatLayer([], {
  radius: 35, blur: 25, minOpacity: 0.35
}).addTo(map);

const camadaZonas = L.layerGroup().addTo(map);

/* =====================
   GRID
===================== */
function gerarGrid(bounds, tamanho) {
  const grid = [];
  for (let lat = bounds.getSouth(); lat < bounds.getNorth(); lat += tamanho) {
    for (let lng = bounds.getWest(); lng < bounds.getEast(); lng += tamanho) {
      grid.push({ bounds: [[lat,lng],[lat+tamanho,lng+tamanho]], peso:0 });
    }
  }
  return grid;
}

/* =====================
   RECALCULAR
===================== */
function recalcularMapa(dados) {
  camadaZonas.clearLayers();
  camadaHeatmap.setLatLngs([]);

  const grid = gerarGrid(map.getBounds(), 0.01);
  let maxPeso = 0;

  dados.forEach(e => {
    if (!e.lat || !e.lng) return;

    let peso = 0.3;
    if (modoIndicador === 1) peso = e.status.includes("cr√≠tica") ? 1.5 : e.status.includes("alerta") ? 1.0 : 0.3;
    if (modoIndicador === 2) peso = e.status.includes("cr√≠tica") ? 1.2 : e.status.includes("alerta") ? 0.8 : 0.3;

    camadaHeatmap.addLatLng([e.lat, e.lng, peso]);

    grid.forEach(c => {
      const [[a,b],[c2,d]] = c.bounds;
      if (e.lat>=a && e.lat<c2 && e.lng>=b && e.lng<d) c.peso += peso;
      maxPeso = Math.max(maxPeso, c.peso);
    });
  });

  const ranking = grid
    .filter(c => c.peso > 0)
    .sort((a,b) => b.peso - a.peso)
    .slice(0,5);

  const lista = document.getElementById("listaRanking");
  lista.innerHTML = "";

  ranking.forEach((c,i) => {
    const indice = Math.round((c.peso / maxPeso) * 100);

    lista.innerHTML += `<li>Zona ${i+1} ‚Äî √çndice Territorial: ${indice}</li>`;

    L.rectangle(c.bounds,{
      color:"#de2d26", fillOpacity:0.4, weight:1
    }).addTo(camadaZonas);
  });
}

/* =====================
   EVENTOS
===================== */
fetch(API_URL).then(r=>r.json()).then(d=>{
  dadosOriginais = d;
  recalcularMapa(dadosOriginais);
});

document.getElementById("seletorIndicador").addEventListener("change",e=>{
  modoIndicador = Number(e.target.value);
  recalcularMapa(dadosOriginais);
});

document.getElementById("toggleZonas").addEventListener("change",e=>{
  e.target.checked ? map.addLayer(camadaZonas) : map.removeLayer(camadaZonas);
});
</script>

</body>
</html>
