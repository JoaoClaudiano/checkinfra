<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="utf-8">
<title>CheckInfra — Áreas de Influência Crítica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>

<style>
html, body, #map {
  height: 100%;
  margin: 0;
}

header {
  background:#1f4fd8;
  color:#fff;
  padding:12px;
  text-align:center;
  font-weight:bold;
}

footer {
  position:fixed;
  bottom:0;
  width:100%;
  background:#f4f6f8;
  font-size:11px;
  text-align:center;
  padding:6px;
  border-top:1px solid #ccc;
}

</style>
</head>

<body>

<header>CheckInfra — Áreas de Influência Sanitária</header>
<div id="map"></div>
<footer>Análise territorial automatizada · Não substitui inspeção técnica presencial</footer>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://d3js.org/d3-delaunay.v6.min.js"></script>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

/* ===============================
   FIREBASE
================================ */
const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

/* ===============================
   MAPA BASE
================================ */
const map = L.map("map").setView([-3.7319, -38.5267], 12);

L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  attribution: "© OpenStreetMap"
}).addTo(map);

/* ===============================
   LIMITE TERRITORIAL
================================ */
const limiteGeo = await fetch("POLIGONAIS.geojson").then(r => r.json());

const limiteLayer = L.geoJSON(limiteGeo, {
  style:{
    color:"#000",
    weight:2,
    fillOpacity:0
  }
}).addTo(map);

map.fitBounds(limiteLayer.getBounds());

/* ===============================
   LER FIRESTORE
================================ */
const snap = await getDocs(collection(db,"escolas"));

const critico = [];
const atencao = [];

snap.forEach(doc=>{
  const d = doc.data();
  if(typeof d.lat !== "number") return;

  if(d.classe === "critico") critico.push(d);
  if(d.classe === "atencao") atencao.push(d);
});

/* ===============================
   FUNÇÃO VORONOI
================================ */
function desenharVoronoi(escolas, cor, titulo){
  if(escolas.length === 0) return;

  const pontos = escolas.map(e=>{
    const p = map.latLngToLayerPoint([e.lat,e.lng]);
    return [p.x,p.y];
  });

  const delaunay = d3.Delaunay.from(pontos);
  const size = map.getSize();

  const voronoi = delaunay.voronoi([0,0,size.x,size.y]);

  escolas.forEach((e,i)=>{
    const cell = voronoi.cellPolygon(i);
    if(!cell) return;

    const latlngs = cell.map(p =>
      map.layerPointToLatLng([p[0],p[1]])
    );

    L.polygon(latlngs,{
      color:cor,
      weight:1,
      fillColor:cor,
      fillOpacity:0.35
    })
    .bindPopup(`
      <strong>${e.nome}</strong><br>
      Classe: ${titulo}<br>
      Área de influência exclusiva
    `)
    .addTo(map);
  });
}

/* ===============================
   DESENHAR VORONOI
================================ */
desenharVoronoi(critico,"#b30000","Crítico");
desenharVoronoi(atencao,"#ff9800","Atenção");

/* ===============================
   PONTOS DAS ESCOLAS
================================ */
function desenharPontos(lista, cor){
  lista.forEach(e=>{
    L.circleMarker([e.lat,e.lng],{
      radius:6,
      color:"#000",
      fillColor:cor,
      fillOpacity:1
    })
    .bindPopup(`<strong>${e.nome}</strong><br>${e.classe}`)
    .addTo(map);
  });
}

desenharPontos(critico,"#b30000");
desenharPontos(atencao,"#ff9800");

</script>
</body>
</html>