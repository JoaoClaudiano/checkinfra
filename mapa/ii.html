<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CheckInfra ‚Äî Mapa do Gestor</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<style>
body { margin:0; font-family:Arial, sans-serif; background:#f4f6f8; }
header {
  background:#1f4fd8; color:#fff; text-align:center;
  padding:14px; font-weight:bold; position:sticky; top:0; z-index:1000;
}
footer {
  background:#1f4fd8; color:#fff; text-align:center;
  padding:8px; font-size:12px;
}
.painel {
  display:flex; flex-wrap:wrap; gap:10px;
  justify-content:center; padding:8px;
  background:#fff; border-bottom:1px solid #ddd;
}
label { font-size:13px; cursor:pointer; }
.bola {
  width:12px; height:12px; border-radius:50%; display:inline-block;
}
.verde{background:#4CAF50;}
.amarelo{background:#FFD700;}
.laranja{background:#FF9800;}
.vermelho{background:#F44336;}

#map { height: calc(100vh - 160px); }

.pulse-critico { animation:pulse-red 2.2s infinite; }
.pulse-atencao { animation:pulse-orange 2.2s infinite; }
.pulse-alerta  { animation:pulse-yellow 2.2s infinite; }
.pulse-adequado{ animation:pulse-green 2.2s infinite; }

@keyframes pulse-red {0%{r:7;opacity:.8;}70%{r:18;opacity:0;}}
@keyframes pulse-orange {0%{r:7;opacity:.8;}70%{r:16;opacity:0;}}
@keyframes pulse-yellow {0%{r:7;opacity:.8;}70%{r:14;opacity:0;}}
@keyframes pulse-green {0%{r:7;opacity:.7;}70%{r:12;opacity:0;}}
</style>
</head>

<body>

<header>Mapa Sanit√°rio das Escolas ‚Äî CheckInfra</header>

<div class="painel">
  <label><input type="checkbox" checked id="fAdequado"><span class="bola verde"></span> Adequado</label>
  <label><input type="checkbox" checked id="fAlerta"><span class="bola amarelo"></span> Alerta</label>
  <label><input type="checkbox" checked id="fAtencao"><span class="bola laranja"></span> Aten√ß√£o</label>
  <label><input type="checkbox" checked id="fCritico"><span class="bola vermelho"></span> Cr√≠tico</label>
  <label><input type="checkbox" checked id="pulso"> Mapa vivo</label>
  <label><input type="checkbox" id="poligonos"> Pol√≠gonos</label>
</div>

<div id="map"></div>

<footer>
  Diagn√≥stico preliminar ‚Äî n√£o substitui vistoria t√©cnica presencial.
</footer>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import { getFirestore, collection, getDocs } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const map = L.map("map").setView([-3.7319,-38.5267],12);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png").addTo(map);

let avaliacoes = [];
let camadaPoligonos = null;

function corStatus(s){
  if(s==="critico") return "#F44336";
  if(s==="atencao") return "#FF9800";
  if(s==="alerta") return "#FFD700";
  return "#4CAF50";
}

function pulsoClasse(s){
  if(!document.getElementById("pulso").checked) return "";
  if(s==="critico") return "pulse-critico";
  if(s==="atencao") return "pulse-atencao";
  if(s==="alerta") return "pulse-alerta";
  return "pulse-adequado";
}

async function carregarAvaliacoes(){
  const snap = await getDocs(collection(db,"avaliacoes"));
  avaliacoes = [];
  snap.forEach(d=>{
    const x=d.data();
    if(x.lat && x.lng) avaliacoes.push(x);
  });
}

function desenharPontos(){
  map.eachLayer(l=>{ if(l instanceof L.CircleMarker) map.removeLayer(l); });

  avaliacoes.forEach(d=>{
    if(!document.getElementById("f"+d.classe.charAt(0).toUpperCase()+d.classe.slice(1)).checked) return;
    L.circleMarker([d.lat,d.lng],{
      radius:7,
      color:corStatus(d.classe),
      fillColor:corStatus(d.classe),
      fillOpacity:.8,
      className:pulsoClasse(d.classe)
    }).bindPopup(`<b>${d.escola}</b><br>Status: ${d.classe}`)
      .addTo(map);
  });
}

async function desenharPoligonos(){
  if(camadaPoligonos){ map.removeLayer(camadaPoligonos); camadaPoligonos=null; }
  if(!document.getElementById("poligonos").checked) return;

  const geo = await fetch("POLIGONAIS.geojson").then(r=>r.json());

  camadaPoligonos = L.geoJSON(geo,{
    style:f=>{
      const dentro = avaliacoes.filter(a=>L.geoJSON(f).getBounds().contains([a.lat,a.lng]));
      if(!dentro.length) return {fillOpacity:0, color:"#999"};

      const total=dentro.length;
      const crit=dentro.filter(a=>a.classe==="critico").length;
      const pct=crit/total*100;

      let cor="#4CAF50";
      if(pct>=50) cor="#F44336";
      else if(pct>=30) cor="#FF9800";
      else if(crit>=1) cor="#FFD700";

      return {color:"#444", weight:1, fillColor:cor, fillOpacity:.45};
    },
    onEachFeature:(f,l)=>{
      const dentro = avaliacoes.filter(a=>l.getBounds().contains([a.lat,a.lng]));
      const total=dentro.length;
      const c=dentro.filter(a=>a.classe==="critico").length;
      const a=dentro.filter(a=>a.classe==="atencao").length;
      const al=dentro.filter(a=>a.classe==="alerta").length;
      const ok=dentro.filter(a=>a.classe==="ok").length;

      let obs="Sem criticidade";
      if(c>=1) obs = `${Math.round(c/total*100)}% cr√≠tico ‚Äì aten√ß√£o localizada`;

      l.bindTooltip(`
        <b>${f.properties.nome||"√Årea"}</b><br>
        üî¥ Cr√≠tico: ${Math.round(c/total*100)}% (${c})<br>
        üü† Aten√ß√£o: ${Math.round(a/total*100)}% (${a})<br>
        üü° Alerta: ${Math.round(al/total*100)}% (${al})<br>
        üü¢ Adequado: ${Math.round(ok/total*100)}% (${ok})<br>
        <i>${obs}</i>
      `);
    }
  }).addTo(map);
}

async function atualizar(){
  await carregarAvaliacoes();
  desenharPontos();
  desenharPoligonos();
}

document.querySelectorAll("input").forEach(i=>i.onchange=atualizar);
atualizar();
</script>

</body>
</html>