<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Painel ‚Äî CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<meta name="theme-color" content="#1f4fd8">

<link rel="manifest" href="manifest.json">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<style>
body{margin:0;font-family:Arial;background:#f4f6f8}
header{
  display:flex;align-items:center;justify-content:space-between;
  background:#1f4fd8;color:#fff;padding:12px 16px;
}
header h1{margin:0;font-size:18px;text-align:center;flex:1}
header button{
  background:none;border:none;color:#fff;font-size:22px;cursor:pointer
}
.container{padding:16px}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:16px}
.card{
  background:#fff;border-radius:10px;padding:16px
}
table{width:100%;border-collapse:collapse;font-size:13px}
th,td{
  border-bottom:1px solid #ddd;
  padding:8px;
  text-align:center;
}
th{background:#f0f2f5}

.badge{padding:4px 8px;border-radius:12px;color:#fff;font-size:12px}
.Adequada{background:#4caf50}
.Alerta{background:#fbc02d;color:#000}
.Aten√ß√£o{background:#ff7043}
.Cr√≠tica{background:#f44336}

canvas{max-height:300px}

/* Sidebar */
#sidebar{
  position:fixed;top:0;right:-280px;
  width:260px;height:100%;
  background:#1f4fd8;color:#fff;
  padding:16px;transition:.3s;z-index:1000
}
#sidebar.open{right:0}
#sidebar a{color:#fff;text-decoration:none;display:block;margin:12px 0}
#sidebar .close{
  font-size:20px;text-align:right;cursor:pointer
}
</style>
</head>

<body>

<header>
  <button onclick="history.back()">‚Üê</button>
  <h1>Painel CheckInfra</h1>
  <button onclick="toggleSidebar()">‚ò∞</button>
</header>

<div id="sidebar">
  <div class="close" onclick="toggleSidebar()">‚úï</div>
  <a href="metodologia.html">üìò Metodologia IPT</a>
</div>

<div class="container">

<div class="grid">
  <div class="card">
    <h3>Status das Unidades</h3>
    <canvas id="graficoStatus"></canvas>
  </div>
  <div class="card">
    <h3>Frequ√™ncia de Problemas</h3>
    <canvas id="graficoProblemas"></canvas>
  </div>
</div>

<div class="card">
  <h3>Ranking por IPT</h3>
  <table id="ranking">
    <thead>
      <tr>
        <th>#</th>
        <th>Escola</th>
        <th>Status</th>
        <th>IPT</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

<div class="card">
  <h3>Hist√≥rico de Avalia√ß√µes</h3>
  <table id="historico">
    <thead>
      <tr>
        <th>Escola</th>
        <th>Status</th>
        <th>IPT</th>
        <th>Data</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>

</div>

<script>
const firebaseConfig = {
  /* MESMA CONFIGURA√á√ÉO QUE VOC√ä J√Å USA */
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

function toggleSidebar(){
  document.getElementById("sidebar").classList.toggle("open");
}

const pesoGS=0.4, pesoIT=0.4, pesoRT=0.2;
const mapaGS={Adequada:1,Alerta:2,Aten√ß√£o:3,Cr√≠tica:4};

db.ref("avaliacoes").once("value").then(snap=>{
  const dados=Object.values(snap.val()||{});

  const historicoBody=document.querySelector("#historico tbody");
  const rankingBody=document.querySelector("#ranking tbody");

  const porEscola={}, statusCount={}, problemasCount={};

  dados.forEach(a=>{
    const d=new Date(a.createdAt||Date.now());
    historicoBody.innerHTML+=`
      <tr>
        <td>${a.escola}</td>
        <td><span class="badge ${a.status}">${a.status}</span></td>
        <td>${a.ipt||"-"}</td>
        <td>${d.toLocaleDateString()}</td>
      </tr>
    `;

    if(!porEscola[a.escola] || d > porEscola[a.escola].data){
      porEscola[a.escola]={...a,data:d};
    }

    statusCount[a.status]=(statusCount[a.status]||0)+1;

    (a.problemas||[]).forEach(p=>{
      problemasCount[p]=(problemasCount[p]||0)+1;
    });
  });

  const ranking=[];
  Object.values(porEscola).forEach(e=>{
    const gs=mapaGS[e.status]||1;
    const it=e.pontuacao||0;

    const recorrencia=dados.filter(d=>d.escola===e.escola && d.status===e.status).length;
    const rt=Math.min(recorrencia,5);

    const ipt=Math.round(gs*pesoGS + it*pesoIT + rt*pesoRT);

    ranking.push({...e,ipt});
  });

  ranking.sort((a,b)=>b.ipt-a.ipt);

  ranking.forEach((e,i)=>{
    rankingBody.innerHTML+=`
      <tr>
        <td>${i+1}</td>
        <td>${e.escola}</td>
        <td><span class="badge ${e.status}">${e.status}</span></td>
        <td>${e.ipt}</td>
      </tr>
    `;
  });

  new Chart(graficoStatus,{
    type:"pie",
    data:{labels:Object.keys(statusCount),
      datasets:[{data:Object.values(statusCount)}]}
  });

  new Chart(graficoProblemas,{
    type:"bar",
    data:{labels:Object.keys(problemasCount),
      datasets:[{data:Object.values(problemasCount)}]}
  });
});
</script>

</body>
</html>