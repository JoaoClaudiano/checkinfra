<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<!-- Google tag (gtag.js) -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-DD4SQ88NVT"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-DD4SQ88NVT');
</script>
  
<title>Painel da Secretaria</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<link rel="manifest" href="./manifest.json">
<link rel="apple-touch-icon" href="./icons/apple-touch-icon.png">
<meta name="theme-color" content="#1f4fd8">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-title" content="CheckInfra">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<style>
  .nav-global {
  position: fixed;
  top: 12px;
  left: 12px;
  display: flex;
  gap: 8px;
  z-index: 9999;
}

.nav-global button,
.nav-global a {
  background: rgba(31,79,216,0.95);
  color: #fff;
  border: none;
  border-radius: 50%;
  width: 38px;
  height: 38px;
  cursor: pointer;
  font-size: 18px;
  display: flex;
  align-items: center;
  justify-content: center;
  text-decoration: none;
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}

.nav-global button:hover,
.nav-global a:hover {
  background: #163aa9;
}
body { font-family: Arial; background:#f4f6f8; padding:20px; }
.card { background:#fff; max-width:1100px; margin:20px auto; padding:20px; border-radius:8px; }
.grid { display:grid; grid-template-columns: 1fr 1fr; gap:20px; }
h2 { margin:0 0 10px; }
small { color:#666; }
.grafico { max-width:500px; margin:auto; }
</style>
</head>
<body>
<div class="nav-global">
  <button onclick="history.back()" title="Voltar">
    ‚¨ÖÔ∏è
  </button>

  <a href="./index.html" title="In√≠cio">
    üè†
  </a>
</div>
<div class="card">
  <h2>Painel da Secretaria</h2>
  <small>Dados consolidados das avalia√ß√µes sanit√°rias</small>
</div>

<div class="card grid">
  <div>
    <h3>Status das Avalia√ß√µes</h3>
    <div class="grafico">
      <canvas id="graficoStatus"></canvas>
    </div>
  </div>

  <div>
    <h3>Principais Problemas (estimativa t√©cnica)</h3>
    <canvas id="graficoProblemas"></canvas>
  </div>
</div>

<div class="card">
  <h3>Dias em Situa√ß√£o Cr√≠tica</h3>
  <canvas id="graficoTempo"></canvas>
</div>

<script>
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbyt4wD8LQ67NOD-Zz7EEvfc7RuYEhKDYE50gkK7rp-47idg6STKUGqk5pYVDclamentdQ/exec";

  
fetch(SCRIPT_URL)
  .then(r => r.json())
  .then(dados => montarGraficos(dados))
  .catch(() => alert("Erro ao carregar dados do painel"));

function montarGraficos(dados) {

  /* ===== STATUS ===== */
  const statusCount = { adequada:0, alerta:0, critica:0 };

  dados.forEach(d => {
    const s = (d.status || "").toLowerCase();
    if (s.includes("cr√≠tica")) statusCount.critica++;
    else if (s.includes("alerta")) statusCount.alerta++;
    else statusCount.adequada++;
  });

  new Chart(graficoStatus, {
    type: "pie",
    data: {
      labels: ["Adequada","Alerta","Cr√≠tica"],
      datasets: [{
        data: [
          statusCount.adequada,
          statusCount.alerta,
          statusCount.critica
        ],
        backgroundColor: ["#4caf50","#ff9800","#f44336"]
      }]
    }
  });

  /* ===== PRINCIPAIS PROBLEMAS (DERIVADOS) ===== */
  const problemasCount = {
    "Problemas estruturais graves": 0,
    "Problemas sanit√°rios recorrentes": 0
  };

  dados.forEach(d => {
    const p = Number(d.pontuacao || 0);
    if (p >= 9) problemasCount["Problemas estruturais graves"]++;
    else if (p >= 4) problemasCount["Problemas sanit√°rios recorrentes"]++;
  });

  new Chart(graficoProblemas, {
    type: "bar",
    data: {
      labels: Object.keys(problemasCount),
      datasets: [{
        label: "Ocorr√™ncias",
        data: Object.values(problemasCount),
        backgroundColor: "#1f4fd8"
      }]
    },
    options: {
      indexAxis: "y",
      scales: { x: { beginAtZero: true } }
    }
  });

  /* ===== CR√çTICOS POR DIA ===== */
  const porDia = {};

  dados.forEach(d => {
    if (!d.timestamp || !d.status) return;
    if (!d.status.toLowerCase().includes("cr√≠tica")) return;
    const dia = d.timestamp.toString().split("T")[0];
    porDia[dia] = (porDia[dia] || 0) + 1;
  });

  new Chart(graficoTempo, {
    type: "line",
    data: {
      labels: Object.keys(porDia),
      datasets: [{
        label: "Registros cr√≠ticos",
        data: Object.values(porDia),
        borderColor: "#f44336",
        fill: false
      }]
    }
  });
}
</script>

</body>
</html>
