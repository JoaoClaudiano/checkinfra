<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link rel="manifest" href="./manifest.json">
<meta name="theme-color" content="#1f4fd8">

<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{
  font-family:Arial,sans-serif;
  background:#f4f6f8;
  margin:0;
  min-height:100vh;
  display:flex;
  flex-direction:column;
}

.header{
  background:#1f4fd8;
  color:#fff;
  padding:26px 16px;
  font-size:19px;
  font-weight:bold;
  text-align:center;
  position:relative;
}

.nav-global{
  position:absolute;
  left:14px;
  top:50%;
  transform:translateY(-50%);
  display:flex;
  gap:12px;
}

.nav-global a,
.nav-global button{
  background:none;
  border:none;
  font-size:20px;
  color:#fff;
  cursor:pointer;
}

.container{
  max-width:900px;
  margin:20px auto;
  padding:0 14px;
  flex:1;
}

.card{
  background:#fff;
  border-radius:14px;
  padding:18px;
  margin-bottom:18px;
  box-shadow:0 2px 6px rgba(0,0,0,.08);
}

label{font-weight:bold;display:block;margin-bottom:6px;}

select,input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ccc;
  margin-bottom:10px;
}

.card-grande h3{
  color:#1f4fd8;
  margin-bottom:10px;
}

.info{
  font-size:14px;
  margin-left:6px;
  cursor:help;
}

.checklist{
  display:flex;
  flex-direction:column;
  gap:10px;
}

.check-card{
  padding:12px;
  border-radius:12px;
  background:#fafafa;
  border:2px solid #e0e0e0;
  cursor:pointer;
  transition:.2s;
}

.check-card.selected{
  border-color:#1f4fd8;
  background:#eaf0ff;
  font-weight:bold;
}

.upload-box{
  border:2px dashed #bbb;
  border-radius:14px;
  padding:18px;
  text-align:center;
}

.upload-preview{
  display:flex;
  gap:8px;
  justify-content:center;
  flex-wrap:wrap;
  margin-top:10px;
}

.upload-preview img{
  width:80px;
  border-radius:8px;
  border:1px solid #ccc;
}

button{
  width:100%;
  padding:15px;
  background:#1f4fd8;
  color:#fff;
  border:none;
  border-radius:12px;
  font-size:16px;
  font-weight:bold;
}

.resultado{
  display:none;
  padding:18px;
  border-radius:14px;
  font-weight:bold;
}

.resultado-ok{background:#d4edda;color:#155724;}
.resultado-alerta{background:#fff3cd;color:#856404;}
.resultado-atencao{background:#ffe8cc;color:#8a5a00;}
.resultado-critico{background:#f8d7da;color:#721c24;}

.selo{
  display:inline-block;
  padding:6px 12px;
  border-radius:20px;
  margin-bottom:10px;
}
</style>
</head>

<body>

<div class="header">
  <div class="nav-global">
    <button onclick="history.back()">‚¨ÖÔ∏è</button>
    <a href="./index.html">üè†</a>
  </div>
  CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria
</div>

<div class="container">

<form id="form-avaliacao">

<div class="card">
  <label>Escola</label>
  <select id="escola" required>
    <option value="">Selecione a escola</option>
  </select>

  <label>Avaliador</label>
  <input id="avaliador" required>
</div>

<div class="card card-grande">
<h3>üèóÔ∏è Estrutura <span class="info" title="Condi√ß√µes f√≠sicas e estruturais do ambiente">‚ìò</span></h3>
<div class="checklist">
  <div class="check-card" data-peso="3">Mofo ou umidade excessiva</div>
  <div class="check-card" data-peso="2">Piso danificado</div>
</div>
</div>

<div class="card card-grande">
<h3>üßπ Higiene <span class="info" title="Condi√ß√µes de limpeza e salubridade">‚ìò</span></h3>
<div class="checklist">
  <div class="check-card" data-peso="2">Limpeza inadequada</div>
  <div class="check-card" data-peso="2">Mau cheiro</div>
</div>
</div>

<div class="card card-grande">
<h3>üí° Conforto <span class="info" title="Ilumina√ß√£o e ventila√ß√£o do ambiente">‚ìò</span></h3>
<div class="checklist">
  <div class="check-card" data-peso="1">Ilumina√ß√£o insuficiente</div>
  <div class="check-card" data-peso="1">Ventila√ß√£o inadequada</div>
</div>
</div>

<div class="card upload-box">
<h3>üì∑ Registro Fotogr√°fico</h3>
<input type="file" id="fotos" accept="image/*" multiple>
<div class="upload-preview" id="preview"></div>
</div>

<button type="submit">Gerar diagn√≥stico e PDF</button>
</form>

<div id="resultado" class="resultado"></div>

</div>

<script src="./mapa/escolas.js"></script>

<script>
const imagens=[];
document.querySelectorAll(".check-card").forEach(c=>{
  c.onclick=()=>c.classList.toggle("selected");
});

document.getElementById("fotos").onchange=e=>{
  const preview=document.getElementById("preview");
  preview.innerHTML="";
  imagens.length=0;
  [...e.target.files].forEach(f=>{
    const r=new FileReader();
    r.onload=ev=>{
      imagens.push(ev.target.result);
      const img=document.createElement("img");
      img.src=ev.target.result;
      preview.appendChild(img);
    };
    r.readAsDataURL(f);
  });
};

document.getElementById("form-avaliacao").onsubmit=e=>{
  e.preventDefault();

  let pontos=0;
  document.querySelectorAll(".check-card.selected")
    .forEach(c=>pontos+=+c.dataset.peso);

  let classe="ok", texto="üü¢ Condi√ß√£o adequada";
  if(pontos>=4&&pontos<=6){classe="alerta";texto="üü° Situa√ß√£o de alerta";}
  else if(pontos>=7&&pontos<=8){classe="atencao";texto="üü† Aten√ß√£o elevada";}
  else if(pontos>=9){classe="critico";texto="üî¥ Condi√ß√£o cr√≠tica";}

  const dados={
    escola:escola.value,
    avaliador:avaliador.value,
    pontos,texto,imagens
  };

  if(!navigator.onLine){
    localStorage.setItem("checkinfra_pendente",JSON.stringify(dados));
  }

  const r=document.getElementById("resultado");
  r.className="resultado resultado-"+classe;
  r.style.display="block";
  r.innerHTML=`
    <div class="selo" title="Classifica√ß√£o baseada na pontua√ß√£o">${texto}</div><br>
    Escola: ${dados.escola}<br>
    Avaliador: ${dados.avaliador}<br>
    Pontua√ß√£o: ${pontos}<br>
    ${navigator.onLine?"‚òÅÔ∏è Enviado":"üì¥ Salvo offline"}
  `;

  const {jsPDF}=window.jspdf;
  const pdf=new jsPDF();
  pdf.text("CheckInfra ‚Äì Avalia√ß√£o Sanit√°ria",10,15);
  pdf.text(`Escola: ${dados.escola}`,10,30);
  pdf.text(`Avaliador: ${dados.avaliador}`,10,40);
  pdf.text(`Status: ${texto}`,10,50);

  imagens.forEach(img=>{
    pdf.addPage();
    pdf.addImage(img,"JPEG",10,20,180,0);
  });

  pdf.save("checkinfra.pdf");
  setTimeout(()=>location.href="./index.html",4000);
};

window.addEventListener("online",()=>{
  const pendente=localStorage.getItem("checkinfra_pendente");
  if(pendente) localStorage.removeItem("checkinfra_pendente");
});
</script>

</body>
</html>
