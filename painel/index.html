<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8" />
<title>Painel Gerencial ‚Äì CheckInfra</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<meta name="theme-color" content="#1f4fd8">

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

<style>
* { box-sizing: border-box; }
body { margin:0; font-family: Arial; background:#f4f6f8; display:flex; justify-content:center; }

/* SIDEBAR */
.sidebar {
  width:240px;
  background:#1f4fd8;
  color:#fff;
  padding:20px;
  position:fixed;
  right:0;
  top:0;
  bottom:0;
  overflow:auto;
  display:flex;
  flex-direction:column;
  z-index:10;
}
.sidebar h3 { margin-top:0; font-size:18px; display:flex; justify-content:space-between; align-items:center; }
.sidebar h3 span { cursor:pointer; font-weight:bold; }
.sidebar a {
  display:block;
  color:#fff;
  text-decoration:none;
  padding:10px 0;
  border-bottom:1px solid rgba(255,255,255,.2);
}

/* CONTE√öDO */
.main {
  max-width:1100px;
  width:100%;
  padding:20px;
}

/* HEADER */
.header {
  display:flex;
  align-items:center;
  justify-content:space-between;
  background:#1f4fd8;
  color:#fff;
  border-radius:10px;
  padding:10px 20px;
  margin-bottom:20px;
}
.header h2 { margin:0; flex:1; text-align:center; }
.header button { background:none; border:none; color:#fff; font-size:20px; cursor:pointer; }

/* CARDS */
.card {
  background:#fff;
  border-radius:10px;
  padding:20px;
  margin-bottom:20px;
}
.grid { display:grid; grid-template-columns: repeat(auto-fit,minmax(180px,1fr)); gap:16px; justify-items:center; }
.kpi { background:#f9fafb; border-radius:10px; padding:16px; text-align:center; width:180px; }
.kpi h4 { margin:0; font-size:14px; color:#555; }
.kpi strong { font-size:30px; display:block; margin-top:6px; }

.badge { padding:4px 8px; border-radius:12px; color:#fff; font-size:12px; }
.adequada { background:#4caf50; }
.alerta { background:orange; color:#fff; }
.atencao { background:#ff7043; }
.critica { background:#f44336; }

table { width:100%; border-collapse: collapse; font-size:14px; }
th, td { padding:8px; border-bottom:1px solid #eee; text-align:center; }
th { background:#f4f6f8; }

button { padding:10px 14px; background:#1f4fd8; color:#fff; border:none; border-radius:6px; cursor:pointer; margin-right:8px; }
</style>
</head>

<body>

<!-- SIDEBAR -->
<div class="sidebar" id="sidebar">
  <h3>‚ò∞ Menu <span onclick="fecharSidebar()">X</span></h3>
  <a href="metodo.html">üìò Metodologia</a>
</div>

<!-- CONTE√öDO -->
<div class="main">

<div class="header">
  <button onclick="window.history.back()">‚Üê</button>
  <h2>Painel Gerencial ‚Äì CheckInfra</h2>
  <div style="width:20px;"></div>
</div>

<div class="card grid">
  <div class="kpi"><h4>Cr√≠ticas</h4><strong id="kpiCritica">‚Äì</strong></div>
  <div class="kpi"><h4>Aten√ß√£o</h4><strong id="kpiAtencao">‚Äì</strong></div>
  <div class="kpi"><h4>IPT M√©dio</h4><strong id="kpiMedio">‚Äì</strong></div>
  <div class="kpi"><h4>Problemas</h4><strong id="kpiProblemas">‚Äì</strong></div>
</div>

<div class="card grid">
  <div style="width:100%; max-width:350px;"><h3>Status</h3><canvas id="graficoStatus"></canvas></div>
  <div style="width:100%; max-width:350px;"><h3>Top IPT</h3><canvas id="graficoIndice"></canvas></div>
  <div style="width:100%; max-width:350px;"><h3>Problemas</h3><canvas id="graficoProblemas"></canvas></div>
</div>

<div class="card">
  <button onclick="exportarXLSX()">‚¨áÔ∏è Baixar Ranking</button>
  <button onclick="exportarHistorico()">‚¨áÔ∏è Baixar Hist√≥rico Completo</button>
  <br><br>
  <table>
    <thead>
      <tr><th>#</th><th>Escola</th><th>Status</th><th>IPT</th></tr>
    </thead>
    <tbody id="tabelaRanking"></tbody>
  </table>
</div>

</div>

<script>
firebase.initializeApp({
  apiKey: "AIzaSyBvFUBXJwumctgf2DNH9ajSIk5-uydiZa0",
  authDomain: "checkinfra-adf3c.firebaseapp.com",
  projectId: "checkinfra-adf3c"
});

const db = firebase.firestore();
const tabelaRanking = document.getElementById("tabelaRanking");
let rankingGlobal = [];
let historicoGlobal = [];

const PESO_GS = 0.4;
const PESO_IT = 0.4;
const PESO_RT = 0.2;

function classeStatus(s){
  s = (s||"").toLowerCase();
  if(s.includes("cr√≠t")) return "critica";
  if(s.includes("aten")) return "atencao";
  if(s.includes("alerta")) return "alerta";
  return "adequada";
}

function fecharSidebar(){ document.getElementById("sidebar").style.display="none"; }

async function carregarDados(){
  const avaliacoesSnap = await db.collection("avaliacoes").get();
  const historicoSnap = await db.collection("historico").get();
  
  const avaliacoes=[], historico=[];
  avaliacoesSnap.forEach(d=>avaliacoes.push(d.data()));
  historicoSnap.forEach(d=>historico.push(d.data()));

  historicoGlobal = historico;

  // Calcular RT (frequ√™ncia no status)
  const freqMap = {};
  historico.forEach(h=>{
    const key = h.escola + "|" + h.status;
    freqMap[key] = (freqMap[key]||0)+1;
  });

  rankingGlobal = avaliacoes.map((d,i)=>{
    const key = d.escola + "|" + d.status;
    const RT = freqMap[key] || 1;
    const GS = d.status.toLowerCase().includes("cr√≠t") ? 4 : d.status.toLowerCase().includes("aten") ? 3 : d.status.toLowerCase().includes("alerta") ? 2 : 1;
    const IT = Number(d.pontuacao||0);
    const IPT = (GS*PESO_GS) + (IT*PESO_IT) + (RT*PESO_RT);
    return {
      "#": i+1,
      Escola: d.escola,
      Status: d.status,
      IPT: IPT.toFixed(2)
    };
  });

  tabelaRanking.innerHTML="";
  rankingGlobal.forEach(r=>{
    tabelaRanking.innerHTML+=`
      <tr>
        <td>${r["#"]}</td>
        <td>${r.Escola}</td>
        <td><span class="${classeStatus(r.Status)}">${r.Status}</span></td>
        <td>${r.IPT}</td>
      </tr>`;
  });

  // KPIs
  const statusCount = {adequada:0,alerta:0,atencao:0,critica:0};
  avaliacoes.forEach(d=>statusCount[classeStatus(d.status)]++);
  document.getElementById("kpiCritica").innerText = statusCount.critica;
  document.getElementById("kpiAtencao").innerText = statusCount.atencao;
  document.getElementById("kpiMedio").innerText = (rankingGlobal.reduce((a,b)=>a+parseFloat(b.IPT),0)/rankingGlobal.length).toFixed(2);
  document.getElementById("kpiProblemas").innerText = avaliacoes.length;

  // Gr√°ficos
  new Chart(document.getElementById("graficoStatus"),{
    type:"pie",
    data:{ labels:["Adequada","Alerta","Aten√ß√£o","Cr√≠tica"], datasets:[{data:Object.values(statusCount), backgroundColor:["#4caf50","orange","#ff7043","#f44336"]}] }
  });

  const topIPT = [...rankingGlobal].sort((a,b)=>b.IPT - a.IPT).slice(0,10);
  new Chart(document.getElementById("graficoIndice"),{
    type:"bar",
    data:{ labels: topIPT.map(r=>r.Escola), datasets:[{data: topIPT.map(r=>r.IPT), backgroundColor:"#1f4fd8"}] },
    options:{ indexAxis:"y", plugins:{legend:{display:false}} }
  });

  const problemasCount = {};
  avaliacoes.forEach(d=>{ problemasCount[d.status]=(problemasCount[d.status]||0)+1; });
  new Chart(document.getElementById("graficoProblemas"),{
    type:"bar",
    data:{ labels:Object.keys(problemasCount), datasets:[{label:"Ocorr√™ncias", data:Object.values(problemasCount), backgroundColor:"#ff9800"}] },
    options:{ indexAxis:"y", plugins:{legend:{display:false}} }
  });
}

carregarDados();

// Exportar XLSX
window.exportarXLSX = function(){
  if(rankingGlobal.length===0) return alert("Nenhum dado dispon√≠vel");
  const ws = XLSX.utils.json_to_sheet(rankingGlobal);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Ranking");
  XLSX.writeFile(wb, "ranking_checkinfra.xlsx");
};

window.exportarHistorico = function(){
  if(historicoGlobal.length===0) return alert("Nenhum dado dispon√≠vel");
  const exportData = historicoGlobal.map((d,i)=>{
    const key = d.escola + "|" + d.status;
    const RT = historicoGlobal.filter(h=>h.escola===d.escola && h.status===d.status).length;
    const GS = d.status.toLowerCase().includes("cr√≠t") ? 4 : d.status.toLowerCase().includes("aten") ? 3 : d.status.toLowerCase().includes("alerta") ? 2 : 1;
    const IT = Number(d.pontuacao||0);
    const IPT = (GS*PESO_GS) + (IT*PESO_IT) + (RT*PESO_RT);
    return {
      "#": i+1,
      Escola: d.escola,
      Status: d.status,
      IPT: IPT.toFixed(2),
      RT
    };
  });
  const ws = XLSX.utils.json_to_sheet(exportData);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, "Historico");
  XLSX.writeFile(wb, "historico_checkinfra.xlsx");
};
</script>

</body>
</html>